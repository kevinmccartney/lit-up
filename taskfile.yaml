version: 3

tasks:
  app:dev:
    cmds:
      - task: songs:process
      - task: config:generate
      - task: playlist:concatenate
      - npm run dev
  app:build:
    cmd: |
      npm run build
  app:preview:
    cmd: |
      npm run preview
  app:deploy:
    cmds:
      - task: songs:process
      - task: config:generate
      - task: playlist:concatenate
      - task: app:build
      - |
        echo "üöÄ Deploying React app to S3..."
        # Get the S3 bucket name from Terraform outputs
        BUCKET_NAME=$(cd infra && terraform output -raw s3_bucket_name)
        if [ -z "$BUCKET_NAME" ]; then
          echo "‚ùå Error: Could not get S3 bucket name from Terraform outputs"
          echo "Make sure you've run 'task infra:apply' first"
          exit 1
        fi
        echo "üì¶ Deploying to bucket: $BUCKET_NAME"
        # Sync the built React app to S3
        aws s3 sync dist/ s3://$BUCKET_NAME --delete
        if [ $? -eq 0 ]; then
          echo "‚úÖ S3 sync successful!"
          
          # Get CloudFront distribution ID and invalidate cache
          DISTRIBUTION_ID=$(cd infra && terraform output -raw cloudfront_distribution_id)
          if [ -n "$DISTRIBUTION_ID" ]; then
            echo "üîÑ Invalidating CloudFront cache..."
            aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
            if [ $? -eq 0 ]; then
              echo "‚úÖ CloudFront invalidation successful!"
            else
              echo "‚ö†Ô∏è  CloudFront invalidation failed, but deployment was successful"
            fi
          else
            echo "‚ö†Ô∏è  Could not get CloudFront distribution ID, skipping invalidation"
          fi
          
          echo "‚úÖ Deployment successful!"
          echo "üåê Your app is available at: $(cd infra && terraform output -raw website_url)"
        else
          echo "‚ùå Deployment failed"
          exit 1
        fi
  env:init:
    cmd: |
      set -a; source .env; set +a
  infra:init:
    cmds:
      - task: env:init
      - |
        terraform init -reconfigure \
          -backend-config="bucket=$TF_STATE_BUCKET" \
          -backend-config="key=$TF_STATE_KEY" \
          -backend-config="region=$TF_STATE_REGION" \
          -backend-config="dynamodb_table=$TF_STATE_DYNAMODB_TABLE" \
          -backend-config="encrypt=true"
  infra:plan:
    cmd: |
      cd infra && terraform plan
  infra:apply:
    cmd: |
      cd infra && terraform apply
  infra:destroy:
    cmd: |
      cd infra && terraform destroy
  ssl:status:
    desc: "Check SSL certificate validation status"
    cmd: |
      cd infra && terraform output certificate_validation_status
  ssl:info:
    desc: "Display SSL certificate information"
    cmd: |
      echo "SSL Certificate Information:"
      echo "Domain: $(cd infra && terraform output -raw certificate_domain_name)"
      echo "ARN: $(cd infra && terraform output -raw certificate_arn)"
      echo "Status: $(cd infra && terraform output -raw certificate_validation_status)"
      echo ""
      echo "Website URLs:"
      echo "Custom Domain: $(cd infra && terraform output -raw website_url)"
      echo "CloudFront URL: $(cd infra && terraform output -raw cloudfront_url)"
  songs:process:
    desc: "Run the process_songs.py script with virtual environment setup"
    cmds:
      - |
        echo "üêç Setting up Python virtual environment..."
        cd scripts
        if [ ! -d "venv" ]; then
          python -m venv venv
          echo "‚úÖ Virtual environment created"
        else
          echo "‚úÖ Virtual environment already exists"
        fi
        source venv/bin/activate
        echo "üì¶ Installing requirements..."
        pip install -r requirements.txt
        echo "üöÄ Running process_songs.py..."
        python process_songs.py
      - task: songs:analyze
  config:generate:
    desc: "Convert song_list.yaml to appConfig.json for the app"
    cmds:
      - |
        echo "üîÑ Converting YAML to JSON..."
        cd scripts
        if [ ! -d "venv" ]; then
          python -m venv venv
        fi
        source venv/bin/activate
        pip install -r requirements.txt -q
        python generate_config.py
  playlist:concatenate:
    desc: "Create concatenated audio playlist for iOS lock screen compatibility"
    cmds:
      - |
        echo "üéµ Creating concatenated audio playlist..."
        cd scripts
        if [ ! -d "venv" ]; then
          python -m venv venv
        fi
        source venv/bin/activate
        pip install -r requirements.txt -q
        python concatenate_audio.py
  songs:analyze:
    desc: "Analyze existing MP3 files and update song_list.yaml with actual durations"
    cmds:
      - |
        echo "üîç Analyzing MP3 durations..."
        cd scripts
        if [ ! -d "venv" ]; then
          python -m venv venv
        fi
        source venv/bin/activate
        pip install -r requirements.txt -q
        python analyze_mp3_durations.py
